{% extends "layouts/base-fullscreen.html" %}

{% block title %}Login{% endblock %}

{% block stylesheets %}
<style>
    .auth-content .card {
        width: 500px; /* Mengubah lebar card sesuai kebutuhan */
        margin: auto;
    }
    #qr-code {
        display: block;
        margin: auto;
        margin-top: 20px; /* Tambahkan jarak di atas QR code */
    }
    #codeInput {
        margin-top: 20px; /* Tambahkan jarak di atas form kode unik */
    }
    #face-login-modal {
        display: none; 
        position: fixed; 
        z-index: 9999; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.8); 
        justify-content: center;
        align-items: center;
    }
    #face-login-content {
        background-color: transparent;
        margin: auto;
        padding: 20px;
        border: none;
        width: 50%;
        text-align: center;
        position: relative;
    }
    #login-video {
        position: relative;
        width: 100%;
        border-radius: 15px;
        overflow: hidden;
    }
    .scan-line {
        position: absolute;
        width: 80%;
        height: 2px;
        background-color: lime;
        top: 0;
        left: 10%;
        animation: scan 3s infinite;
    }
    @keyframes scan {
        0% { top: 10%; }
        100% { top: 80%; }
    }
    .face-box {
        position: absolute;
        border: 2px solid lime;
        width: 80%;
        height: 80%;
        top: 10%;
        left: 10%;
        border-radius: 15px;
        box-shadow: 0 0 10px lime;
    }
    #close-modal-login {
        position: absolute;
        top: 20px;
        right: 35px;
        color: #fff;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
    }
    #close-modal-login:hover,
    #close-modal-login:focus {
        color: #bbb;
        text-decoration: none;
        cursor: pointer;
    }
    #loading-login {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 1.5em;
        font-weight: bold;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="auth-wrapper">
    <div class="auth-content">
        <div class="auth-bg">
            <span class="r"></span>
            <span class="r s"></span>
            <span class="r s"></span>
            <span class="r"></span>
        </div>
        <div class="card">
            <div class="card-body text-center">
                <div class="mb-4">
                    <i class="feather icon-unlock auth-icon"></i>
                </div>
                <h3 class="mb-4">Masuk</h3>
                {% if msg %}
                    <div class="alert alert-danger" id="error-message">{{ msg }}</div>
                {% else %}
                    <div class="alert alert-danger" id="error-message" style="display: none;"></div>
                {% endif %}
                <form id="loginForm" action="{{ url_for('auth.login') }}" method="POST">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="nik" name="nik" placeholder="NIK" required>
                    </div>
                    <div class="input-group mb-4">
                        <input type="password" class="form-control" id="password" name="password" placeholder="Kata Sandi" required>
                    </div>
                    <button type="submit" class="btn btn-primary shadow-2 mb-4">Login</button>
                </form>
                <hr>
                <div class="text-center">
                    <button id="faceLoginBtn" class="btn btn-secondary btn-block">Login dengan Wajah</button>
                    <button id="qrLoginBtn" class="btn btn-secondary btn-block">Login dengan QR Code</button>
                    <img id="qr-code" src="" alt="QR Code" style="display: none;">
                    <div id="codeInput" style="display: none;">
                        <input type="text" id="userCode" placeholder="Masukkan kode unik Anda" class="form-control mb-2">
                        <button id="submitCodeBtn" class="btn btn-primary btn-block">Submit Kode</button>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <a href="{{ url_for('auth.register') }}" class="btn btn-link">Daftar</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal untuk login wajah -->
<div id="face-login-modal">
    <div id="face-login-content">
        <span id="close-modal-login">&times;</span>
        <h2 style="color: white;">Login dengan Wajah</h2>
        <div style="position: relative; display: inline-block;">
            <video id="login-video" width="640" height="480" autoplay></video>
            <div class="face-box"></div>
            <div class="scan-line"></div>
            <div id="loading-login">Sedang memproses wajah...</div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script>
    document.getElementById('faceLoginBtn').addEventListener('click', function() {
        document.getElementById('face-login-modal').style.display = 'flex';
        const video = document.getElementById('login-video');
        
        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    video.srcObject = stream;
                    video.play();
                    // Mulai login wajah setelah beberapa detik untuk memastikan video berjalan
                    setTimeout(function() {
                        document.getElementById('loading-login').style.display = 'block';
                        fetch('{{ url_for("auth.login_face") }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'sukses') {
                                if (data.user_id) {
                                    window.location.href = '{{ url_for("main.index", user_id=0) }}'.replace('0', data.user_id);
                                } else {
                                    alert('User ID tidak ditemukan.');
                                }
                            } else {
                                alert('Login wajah gagal: ' + data.pesan);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        })
                        .finally(() => {
                            document.getElementById('loading-login').style.display = 'none';
                        });
                    }, 3000);
                })
                .catch(function (error) {
                    console.log("Something went wrong!");
                });
        }
    });

    document.getElementById('qrLoginBtn').addEventListener('click', function() {
        const nik = document.getElementById('nik').value;
        if (!nik) {
            document.getElementById('error-message').innerText = 'Silakan masukkan NIK terlebih dahulu.';
            document.getElementById('error-message').style.display = 'block';
            return;
        }

        document.getElementById('error-message').style.display = 'none';
        
        fetch('{{ url_for("auth.generate_qr") }}?nik=' + nik)
        .then(response => response.blob())
        .then(blob => {
            const url = URL.createObjectURL(blob);
            const qrCodeImg = document.getElementById('qr-code');
            qrCodeImg.src = url;
            qrCodeImg.style.display = 'block';
            document.getElementById('codeInput').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    document.getElementById('submitCodeBtn').addEventListener('click', function() {
        const userCode = document.getElementById('userCode').value;
        if (userCode) {
            fetch('{{ url_for("auth.login_qr") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ qr_code: document.getElementById('nik').value, user_code: userCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'sukses') {
                    window.location.href = '{{ url_for("main.index", user_id=0) }}'.replace('0', data.user_id);
                } else {
                    alert('Login QR Code gagal: ' + data.pesan);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    });

    // Tutup modal login wajah
    document.getElementById('close-modal-login').addEventListener('click', function() {
        document.getElementById('face-login-modal').style.display = 'none';
    });

    // Aktifkan tema gelap secara default
    document.addEventListener('DOMContentLoaded', (event) => {
        document.body.classList.add('dark');
    });
</script>
{% endblock javascripts %}